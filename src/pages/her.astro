---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Her Moments">
    <main class="pt-24 pb-10 px-4 max-w-4xl mx-auto">
        

        <!-- Profile Header -->
        <div class="text-center mb-8" data-aos="fade-down">
            <div
                class="w-28 h-28 mx-auto rounded-full p-1 border-2 border-dashed border-brand-accent mb-4 relative group cursor-pointer">
                <div class="absolute inset-0 rounded-full bg-brand-accent/20 animate-pulse" id="her-photo-pulse"></div>
                <img id="her-photo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                    alt="Anya"
                    class="w-full h-full rounded-full object-cover relative z-10 group-hover:scale-105 transition duration-500 opacity-0"
                    onload="if(this.src !== 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7') this.classList.remove('opacity-0')">
            </div>
            <h1 id="her-name" class="font-serif text-3xl font-bold text-slate-800 dark:text-white mb-2">Her Name</h1>
            <p id="her-title" class="text-brand-accent text-xs uppercase tracking-[0.2em] font-bold mb-4">The Main Character</p>

            <p id="her-bio" class="max-w-sm mx-auto text-slate-500 dark:text-slate-400 italic text-sm leading-relaxed">
                "She is the poem I never knew how to write, and this life is the paper."
            </p>
        </div>

        <!-- NEW: HIGHLIGHTS SECTION -->
        <div class="flex gap-4 md:gap-8 overflow-x-auto pt-4 pb-4 mb-10 justify-start md:justify-center no-scrollbar px-2"
            data-aos="fade-up" data-aos-delay="50">

            <!-- Dynamic Highlights List -->
            <div id="highlightsList" class="flex gap-4">
                <!-- Loading placeholder -->
                <div class="flex flex-col items-center gap-2 min-w-[64px] animate-pulse">
                    <div class="w-16 h-16 rounded-full bg-slate-200 dark:bg-slate-800"></div>
                    <div class="w-12 h-2 rounded bg-slate-200 dark:bg-slate-800"></div>
                </div>
            </div>
        </div>

        <!-- UPDATED: Small Details Grid (Hierarki Diturunkan) -->
        <div class="grid grid-cols-4 gap-2 md:gap-4 mb-12 opacity-70 hover:opacity-100 transition-opacity duration-300"
            data-aos="fade-up" data-aos-delay="100">
            <div
                class="py-2 text-center rounded-xl border border-transparent hover:bg-white/50 dark:hover:bg-slate-800/50 transition-colors">
                <i data-lucide="cake" class="w-4 h-4 mx-auto text-pink-400 mb-1"></i>
                <p class="text-[9px] uppercase tracking-widest text-slate-400">Born</p>
                <p class="font-serif text-sm text-slate-700 dark:text-slate-300">July 24</p>
            </div>
            <div
                class="py-2 text-center rounded-xl border border-transparent hover:bg-white/50 dark:hover:bg-slate-800/50 transition-colors">
                <i data-lucide="cup-soda" class="w-4 h-4 mx-auto text-green-500 mb-1"></i>
                <p class="text-[9px] uppercase tracking-widest text-slate-400">Loves</p>
                <p class="font-serif text-sm text-slate-700 dark:text-slate-300">Matcha</p>
            </div>
            <div
                class="py-2 text-center rounded-xl border border-transparent hover:bg-white/50 dark:hover:bg-slate-800/50 transition-colors">
                <i data-lucide="music-2" class="w-4 h-4 mx-auto text-purple-500 mb-1"></i>
                <p class="text-[9px] uppercase tracking-widest text-slate-400">Vibe</p>
                <p class="font-serif text-sm text-slate-700 dark:text-slate-300">R&B</p>
            </div>
            <div
                class="py-2 text-center rounded-xl border border-transparent hover:bg-white/50 dark:hover:bg-slate-800/50 transition-colors">
                <i data-lucide="lock" class="w-4 h-4 mx-auto text-red-400 mb-1"></i>
                <p class="text-[9px] uppercase tracking-widest text-slate-400">Status</p>
                <p class="font-serif text-sm text-slate-700 dark:text-slate-300">Mine</p>
            </div>
        </div>

        <!-- Her Gallery (Masonry Style) -->
        <div class="mb-6 flex items-center gap-4 px-2" data-aos="fade-right">
            <i data-lucide="grid-3x3" class="w-4 h-4 text-slate-400"></i>
            <span class="text-xs font-bold uppercase tracking-widest text-slate-400">Posts</span>
            <div class="h-px flex-1 bg-slate-200 dark:bg-slate-800"></div>
        </div>

        <div id="gallery-grid" class="columns-2 md:columns-3 gap-4 space-y-4">
            <!-- Loading placeholder -->
            <div class="break-inside-avoid rounded-xl overflow-hidden aspect-square bg-slate-200 dark:bg-slate-800 animate-pulse"></div>
            <div class="break-inside-avoid rounded-xl overflow-hidden aspect-[3/4] bg-slate-200 dark:bg-slate-800 animate-pulse"></div>
            <div class="break-inside-avoid rounded-xl overflow-hidden aspect-square bg-slate-200 dark:bg-slate-800 animate-pulse"></div>
        </div>

    
    </main>
    
<script>

        import { db } from '../lib/firebase-config.js';
        import { doc, getDoc } from 'firebase/firestore';
        
        // Fallback data when Firestore unavailable
        const FALLBACK = {
            photo: 'https://images.unsplash.com/photo-1517841905240-472988babdf9?ixlib=rb-1.2.1&auto=format&fit=crop&w=400&q=80',
            name: 'Her Name',
            title: 'The Main Character',
            bio: 'She is the poem I never knew how to write, and this life is the paper.'
        };
        
        function loadFallback() {
            document.getElementById('her-photo').src = FALLBACK.photo;
            document.getElementById('her-photo-pulse')?.classList.add('hidden');
        }
        
        async function loadProfile() {
            try {
                // Load from profileHer (Princess Profile section in dashboard)
                const profileDoc = await getDoc(doc(db, 'landing', 'profileHer'));
                if (profileDoc.exists()) {
                    const data = profileDoc.data();
                    
                    if (data.name) document.getElementById('her-name').textContent = data.name;
                    if (data.bio) document.getElementById('her-bio').textContent = '"' + data.bio + '"';
                    if (data.photo) document.getElementById('her-photo').src = data.photo;
                    if (data.title) document.getElementById('her-title').textContent = data.title;
                    
                    // Load highlights with fallback
                    renderHighlights(data.highlights || []);
                    
                    // Load gallery (only photos with showOnProfile: true)
                    const visiblePhotos = (data.gallery || []).filter(p => p.showOnProfile);
                    renderGallery(visiblePhotos);
                    
                    // Hide loading pulse
                    document.getElementById('her-photo-pulse')?.classList.add('hidden');
                } else {
                    // No data - keep skeleton, show empty highlights/gallery
                    renderHighlights([]);
                    renderGallery([]);
                }
            } catch (error) {
                console.error('Failed to load profile (skeleton remains):', error);
                // Keep skeleton loading - don't load fallback photos
            }
        }
        
        function renderHighlights(highlights) {
            const container = document.getElementById('highlightsList');
            if (!container) return;
            
            if (!highlights || highlights.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-4 px-8 text-center">
                        <div class="w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-2">
                            <i data-lucide="image" class="w-6 h-6 text-slate-400"></i>
                        </div>
                        <p class="text-slate-400 text-xs">No highlights yet</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = highlights.map(h => `
                <div class="flex flex-col items-center gap-2 min-w-[64px] cursor-pointer group">
                    <div class="w-16 h-16 rounded-full p-[2px] bg-gradient-to-tr ${h.gradient} group-hover:scale-110 transition-transform duration-300 shadow-md">
                        <div class="w-full h-full rounded-full bg-white dark:bg-slate-900 border-[3px] border-white dark:border-slate-900 flex items-center justify-center overflow-hidden">
                            <i data-lucide="${h.icon}" class="w-6 h-6 ${h.iconColor}"></i>
                        </div>
                    </div>
                    <span class="text-[10px] font-medium tracking-wide text-slate-700 dark:text-slate-300">${h.name}</span>
                </div>
            `).join('');
            
            // Re-initialize Lucide icons
            lucide.createIcons();
        }
        
        function renderGallery(photos) {
            const container = document.getElementById('gallery-grid');
            if (!container) return;
            
            if (!photos || photos.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="w-20 h-20 mx-auto rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-4">
                            <i data-lucide="image" class="w-8 h-8 text-slate-400"></i>
                        </div>
                        <p class="text-slate-400 text-sm">No posts yet</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = photos.map((photo, idx) => `
                <div class="break-inside-avoid rounded-xl overflow-hidden group relative cursor-pointer" data-aos="fade-up" data-aos-delay="${idx * 100}">
                    <img src="${photo.url}" class="w-full transform group-hover:scale-110 transition duration-500">
                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition duration-300 flex items-center justify-center flex-col gap-2">
                        <i data-lucide="heart" class="w-6 h-6 text-white fill-white"></i>
                        ${photo.caption ? `<span class="text-white text-xs font-medium">${photo.caption}</span>` : ''}
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
            AOS.refresh();
        }
        
        loadProfile();
    
</script>

</Layout>
