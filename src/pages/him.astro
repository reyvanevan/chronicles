---
import Layout from '../layouts/Layout.astro';
---

<Layout title="Him Moments">
    <main class="pt-24 pb-10 px-4 max-w-4xl mx-auto">
        

        <!-- Profile Header -->
        <div class="text-center mb-8" data-aos="fade-down">
            <div
                class="w-28 h-28 mx-auto rounded-full p-1 border-2 border-dashed border-blue-400 mb-4 relative group cursor-pointer">
                <div class="absolute inset-0 rounded-full bg-blue-400/20 animate-pulse" id="him-photo-pulse"></div>
                <img id="him-photo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"
                    alt="Him"
                    class="w-full h-full rounded-full object-cover relative z-10 group-hover:scale-105 transition duration-500 grayscale hover:grayscale-0 opacity-0"
                    onload="if(this.src !== 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7') this.classList.remove('opacity-0')">
            </div>

            <h1 id="him-name" class="font-serif text-3xl font-bold text-slate-800 dark:text-white mb-2">His Name</h1>
            <p id="him-title" class="text-blue-500 text-xs uppercase tracking-[0.2em] font-bold mb-4">Hououin Kyouma</p>

            <p id="him-bio" class="max-w-sm mx-auto text-slate-500 dark:text-slate-400 italic text-sm leading-relaxed">
                "Penemu Time Leap Machine. Melintas ribuan worldline hanya untuk satu orang."
            </p>
        </div>

        <!-- HIGHLIGHTS SECTION -->
        <div class="flex gap-4 md:gap-8 overflow-x-auto py-4 mb-6 justify-start md:justify-center no-scrollbar px-2 relative z-10"
            data-aos="fade-up" data-aos-delay="50">

            <!-- Dynamic Highlights List -->
            <div id="highlightsList" class="flex gap-4">
                <!-- Loading placeholder -->
                <div class="flex flex-col items-center gap-2 min-w-[64px] animate-pulse">
                    <div class="w-16 h-16 rounded-full bg-slate-200 dark:bg-slate-800"></div>
                    <div class="w-12 h-2 rounded bg-slate-200 dark:bg-slate-800"></div>
                </div>
            </div>
        </div>

        <!-- INFO GRID (Toned Down) -->
        <div class="grid grid-cols-4 gap-2 md:gap-4 mb-12 opacity-70 hover:opacity-100 transition-opacity duration-300"
            data-aos="fade-up" data-aos-delay="100">
            <div
                class="py-2 text-center rounded-xl border border-transparent hover:bg-white/50 dark:hover:bg-slate-800/50 transition-colors">
                <i data-lucide="shield" class="w-4 h-4 mx-auto text-blue-500 mb-1"></i>
                <p id="him-stat-label-0" class="text-[9px] uppercase tracking-widest text-slate-400">Role</p>
                <p id="him-stat-value-0" class="font-serif text-sm text-slate-700 dark:text-slate-300">Mad Scientist</p>
            </div>
            <div
                class="py-2 text-center rounded-xl border border-transparent hover:bg-white/50 dark:hover:bg-slate-800/50 transition-colors">
                <i data-lucide="star" class="w-4 h-4 mx-auto text-yellow-500 mb-1"></i>
                <p id="him-stat-label-1" class="text-[9px] uppercase tracking-widest text-slate-400">Fav</p>
                <p id="him-stat-value-1" class="font-serif text-sm text-slate-700 dark:text-slate-300">You</p>
            </div>
            <div
                class="py-2 text-center rounded-xl border border-transparent hover:bg-white/50 dark:hover:bg-slate-800/50 transition-colors">
                <i data-lucide="gamepad-2" class="w-4 h-4 mx-auto text-purple-500 mb-1"></i>
                <p id="him-stat-label-2" class="text-[9px] uppercase tracking-widest text-slate-400">Hobby</p>
                <p id="him-stat-value-2" class="font-serif text-sm text-slate-700 dark:text-slate-300">Game</p>
            </div>
            <div
                class="py-2 text-center rounded-xl border border-transparent hover:bg-white/50 dark:hover:bg-slate-800/50 transition-colors">
                <i data-lucide="lock" class="w-4 h-4 mx-auto text-red-500 mb-1"></i>
                <p id="him-stat-label-3" class="text-[9px] uppercase tracking-widest text-slate-400">Status</p>
                <p id="him-stat-value-3" class="font-serif text-sm text-slate-700 dark:text-slate-300">Taken</p>
            </div>
        </div>

        <!-- Gallery Title -->
        <div class="mb-6 flex items-center gap-4 px-2" data-aos="fade-right">
            <i data-lucide="aperture" class="w-4 h-4 text-slate-400"></i>
            <span class="text-xs font-bold uppercase tracking-widest text-slate-400">Through My Lens</span>
            <div class="h-px flex-1 bg-slate-200 dark:bg-slate-800"></div>
        </div>

        <!-- Gallery (Masonry) -->
        <div id="gallery-grid" class="columns-2 md:columns-3 gap-4 space-y-4">
            <!-- Loading placeholder -->
            <div class="break-inside-avoid rounded-xl overflow-hidden aspect-square bg-slate-200 dark:bg-slate-800 animate-pulse"></div>
            <div class="break-inside-avoid rounded-xl overflow-hidden aspect-[3/4] bg-slate-200 dark:bg-slate-800 animate-pulse"></div>
            <div class="break-inside-avoid rounded-xl overflow-hidden aspect-square bg-slate-200 dark:bg-slate-800 animate-pulse"></div>
        </div>

    
    </main>
    
<script>

        import { db } from '../lib/firebase-config.js';
        import { doc, getDoc } from 'firebase/firestore';
        
        async function loadProfile() {
            try {
                const profileDoc = await getDoc(doc(db, 'landing', 'profileRey'));
                if (profileDoc.exists()) {
                    const data = profileDoc.data();
                    
                    if (data.name) document.getElementById('him-name').textContent = data.name;
                    if (data.bio) document.getElementById('him-bio').textContent = '"' + data.bio + '"';
                    if (data.photo) document.getElementById('him-photo').src = data.photo;
                    if (data.title) document.getElementById('him-title').textContent = data.title;
                    if (data.stats && data.stats.length >= 1) {
                        data.stats.forEach((stat, i) => {
                            const labelEl = document.getElementById(`him-stat-label-${i}`);
                            const valueEl = document.getElementById(`him-stat-value-${i}`);
                            if (labelEl && stat.label) labelEl.textContent = stat.label;
                            if (valueEl && stat.value) valueEl.textContent = stat.value;
                        });
                    }
                    
                    // Load highlights with fallback
                    renderHighlights(data.highlights || []);
                    
                    // Load gallery (only photos with showOnProfile: true)
                    const visiblePhotos = (data.gallery || []).filter(p => p.showOnProfile);
                    renderGallery(visiblePhotos);
                    
                    // Hide loading pulse
                    document.getElementById('him-photo-pulse')?.classList.add('hidden');
                } else {
                    // No data - keep skeleton, show empty highlights/gallery
                    renderHighlights([]);
                    renderGallery([]);
                }
            } catch (error) {
                console.error('Failed to load profile (skeleton remains):', error);
                // Keep skeleton loading - don't load fallback photos
            }
        }
        
        function renderHighlights(highlights) {
            const container = document.getElementById('highlightsList');
            if (!container) return;
            
            if (!highlights || highlights.length === 0) {
                container.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-4 px-8 text-center">
                        <div class="w-16 h-16 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-2">
                            <i data-lucide="image" class="w-6 h-6 text-slate-400"></i>
                        </div>
                        <p class="text-slate-400 text-xs">No highlights yet</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = highlights.map(h => `
                <div class="flex flex-col items-center gap-2 min-w-[64px] cursor-pointer group">
                    <div class="w-16 h-16 rounded-full p-[2px] bg-gradient-to-tr ${h.gradient} group-hover:scale-110 transition-transform duration-300 shadow-md">
                        <div class="w-full h-full rounded-full bg-white dark:bg-slate-900 border-[3px] border-white dark:border-slate-900 flex items-center justify-center overflow-hidden">
                            <i data-lucide="${h.icon}" class="w-6 h-6 ${h.iconColor}"></i>
                        </div>
                    </div>
                    <span class="text-[10px] font-medium tracking-wide text-slate-700 dark:text-slate-300">${h.name}</span>
                </div>
            `).join('');
            
            // Re-initialize Lucide icons
            lucide.createIcons();
        }
        
        function renderGallery(photos) {
            const container = document.getElementById('gallery-grid');
            if (!container) return;
            
            if (!photos || photos.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="w-20 h-20 mx-auto rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center mb-4">
                            <i data-lucide="aperture" class="w-8 h-8 text-slate-400"></i>
                        </div>
                        <p class="text-slate-400 text-sm">No posts yet</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }
            
            container.innerHTML = photos.map((photo, idx) => `
                <div class="break-inside-avoid rounded-xl overflow-hidden group relative cursor-pointer" data-aos="fade-up" data-aos-delay="${idx * 100}">
                    <img src="${photo.url}" class="w-full grayscale group-hover:grayscale-0 transition duration-500">
                    <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition duration-300 flex items-center justify-center flex-col gap-2">
                        ${photo.caption ? `<span class="text-white font-serif text-xs italic">${photo.caption}</span>` : '<i data-lucide="eye" class="w-5 h-5 text-white"></i>'}
                    </div>
                </div>
            `).join('');
            
            lucide.createIcons();
            AOS.refresh();
        }
        
        loadProfile();
    
</script>

</Layout>
