---
import '../../styles/global.css';
import GalleryUploadModal from '../../components/core/GalleryUploadModal.astro';
import Sidebar from '../../components/core/Sidebar.astro';
import SectionHero from '../../components/core/SectionHero.astro';
import SectionPrincessProfile from '../../components/core/SectionPrincessProfile.astro';
import SectionReyProfile from '../../components/core/SectionReyProfile.astro';
import SectionGallery from '../../components/core/SectionGallery.astro';
import SectionMemories from '../../components/core/SectionMemories.astro';
import SectionLetter from '../../components/core/SectionLetter.astro';
import SectionSiteConfig from '../../components/core/SectionSiteConfig.astro';
---

<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Core Universe System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:ital,wght@0,600;0,700;1,600&display=swap" rel="stylesheet">
    <link href="https://unpkg.com/aos@2.3.1/dist/aos.css" rel="stylesheet">
    <script is:inline src="https://unpkg.com/lucide@latest"></script>
    <script is:inline>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    </script>
</head>
<body class="bg-gradient-to-br from-brand-blue via-slate-50 to-brand-pink dark:from-slate-950 dark:via-slate-900 dark:to-slate-950 min-h-screen text-slate-700 dark:text-slate-300 selection:bg-brand-pink selection:text-brand-accent overflow-x-hidden">

    <GalleryUploadModal />

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 z-[100] bg-gradient-to-br from-brand-blue via-slate-50 to-brand-pink dark:from-slate-950 dark:via-slate-900 dark:to-slate-950 flex items-center justify-center">
        <div class="text-center">
            <div class="w-12 h-12 border-4 border-brand-accent border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-slate-500 dark:text-slate-400 font-medium">Authenticating...</p>
        </div>
    </div>

    <!-- Mobile Overlay -->
    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden transition-opacity duration-300 backdrop-blur-sm"></div>

    <div class="flex min-h-screen relative">
        <Sidebar />

        <main class="flex-1 w-full md:w-auto p-3 md:p-8 space-y-6 md:space-y-8 overflow-x-hidden">

            <!-- Mobile Header -->
            <div class="md:hidden flex justify-between items-center mb-4 glass-card p-3 rounded-xl sticky top-4 z-20">
                <div class="flex items-center gap-2">
                    <i data-lucide="layout-dashboard" class="w-5 h-5 text-brand-accent"></i>
                    <span class="font-serif font-bold text-base">Dashboard</span>
                </div>
                <div class="flex items-center gap-2">
                    <button onclick="toggleTheme()" class="p-2 rounded-full bg-white/50 dark:bg-slate-800/50 hover:scale-105 transition-transform">
                        <i data-lucide="sun" class="w-4 h-4 text-amber-400 hidden dark:block"></i>
                        <i data-lucide="moon" class="w-4 h-4 text-slate-600 block dark:hidden"></i>
                    </button>
                    <button onclick="toggleSidebar()" class="p-2 text-slate-600 dark:text-slate-300 hover:bg-slate-100 dark:hover:bg-slate-800 rounded-lg transition">
                        <i data-lucide="menu" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>

            <!-- Desktop Header -->
            <div class="hidden md:flex justify-between items-end" data-aos="fade-down">
                <div>
                    <h1 id="cms-welcome-header" class="text-3xl font-serif font-bold text-slate-800 dark:text-white mb-1">Welcome back, Rey! ðŸ‘‹</h1>
                    <p class="text-slate-500 dark:text-slate-400">Here's what's happening in your universe today.</p>
                </div>
                <div class="flex gap-4">
                    <button onclick="toggleTheme()" class="p-3 rounded-full glass-card hover:scale-105 transition-transform group">
                        <i data-lucide="sun" class="w-5 h-5 text-amber-400 hidden dark:block group-hover:rotate-90 transition-transform"></i>
                        <i data-lucide="moon" class="w-5 h-5 text-slate-600 block dark:hidden group-hover:-rotate-12 transition-transform"></i>
                    </button>
                    <button class="p-3 rounded-full glass-card hover:scale-105 transition-transform relative">
                        <i data-lucide="bell" class="w-5 h-5 text-slate-600 dark:text-slate-300"></i>
                        <span class="absolute top-2 right-2.5 w-2 h-2 bg-red-500 rounded-full animate-pulse"></span>
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 md:gap-6" id="overview">
                <div class="glass-card p-4 md:p-6 rounded-2xl flex items-center justify-between group hover:-translate-y-1 transition-transform duration-300" data-aos="fade-up" data-aos-delay="100">
                    <div>
                        <p class="text-xs md:text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">Total Visits</p>
                        <h3 id="stat-visits" class="text-2xl md:text-3xl font-bold text-slate-800 dark:text-white">--</h3>
                        <p class="text-xs text-green-500 flex items-center gap-1 mt-2">
                            <i data-lucide="trending-up" class="w-3 h-3"></i> +12% this week
                        </p>
                    </div>
                    <div class="p-3 md:p-4 bg-blue-50 dark:bg-blue-900/30 rounded-xl md:rounded-2xl text-blue-500 group-hover:scale-110 transition-transform">
                        <i data-lucide="eye" class="w-6 h-6 md:w-8 md:h-8"></i>
                    </div>
                </div>
                <div class="glass-card p-4 md:p-6 rounded-2xl flex items-center justify-between group hover:-translate-y-1 transition-transform duration-300" data-aos="fade-up" data-aos-delay="200">
                    <div>
                        <p class="text-xs md:text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">Memories Stored</p>
                        <h3 id="stat-memories" class="text-2xl md:text-3xl font-bold text-slate-800 dark:text-white">--</h3>
                        <p class="text-xs text-pink-500 flex items-center gap-1 mt-2">
                            <i data-lucide="plus" class="w-3 h-3"></i> 3 new today
                        </p>
                    </div>
                    <div class="p-3 md:p-4 bg-pink-50 dark:bg-pink-900/30 rounded-xl md:rounded-2xl text-pink-500 group-hover:scale-110 transition-transform">
                        <i data-lucide="heart" class="w-6 h-6 md:w-8 md:h-8"></i>
                    </div>
                </div>
                <div class="glass-card p-4 md:p-6 rounded-2xl flex items-center justify-between group hover:-translate-y-1 transition-transform duration-300 sm:col-span-2 md:col-span-1" data-aos="fade-up" data-aos-delay="300">
                    <div>
                        <p class="text-xs md:text-sm font-medium text-slate-500 dark:text-slate-400 mb-1">Days Together</p>
                        <h3 id="stat-days" class="text-2xl md:text-3xl font-bold text-slate-800 dark:text-white">--</h3>
                        <p class="text-xs text-purple-500 flex items-center gap-1 mt-2">
                            <i data-lucide="calendar" class="w-3 h-3"></i> Forever to go
                        </p>
                    </div>
                    <div class="p-3 md:p-4 bg-purple-50 dark:bg-purple-900/30 rounded-xl md:rounded-2xl text-purple-500 group-hover:scale-110 transition-transform">
                        <i data-lucide="hourglass" class="w-6 h-6 md:w-8 md:h-8"></i>
                    </div>
                </div>
            </div>

            <!-- Sections -->
            <SectionHero />
            <SectionPrincessProfile />
            <SectionReyProfile />
            <SectionGallery />
            <SectionMemories />
            <SectionLetter />
            <SectionSiteConfig />

        </main>
    </div>

    <!-- CMS Logic -->
    <script>
        import { initAuth } from '../../lib/cms/auth.js';
        import { loadDashboardData } from '../../lib/cms/dashboard.js';
        import { loadSasukeImage } from '../../lib/cms/content.js';
        import { loadSiteConfig } from '../../lib/cms/config.js';
        import '../../lib/cms/gallery.js';
        import '../../lib/cms/profiles.js';
        import '../../lib/cms/content.js';

        initAuth(async () => {
            const config = await loadSiteConfig();
            if (!config.isSetupComplete) {
                window.location.href = '/core/setup';
                return;
            }
            await loadDashboardData();
            loadSasukeImage();
        });

        // Letter live preview
        document.addEventListener('DOMContentLoaded', () => {
            const letterTitle = document.getElementById('letter-title') as HTMLInputElement | null;
            const letterContent = document.getElementById('letter-content') as HTMLTextAreaElement | null;
            const letterQuote = document.getElementById('letter-quote') as HTMLInputElement | null;

            letterTitle?.addEventListener('input', () => {
                const el = document.getElementById('letter-preview-title');
                if (el) el.textContent = letterTitle.value || 'Dear Christina,';
            });
            letterContent?.addEventListener('input', () => {
                const el = document.getElementById('letter-preview-content');
                if (el) el.textContent = letterContent.value || 'Your message will appear here...';
            });
            letterQuote?.addEventListener('input', () => {
                const el = document.getElementById('letter-preview-quote');
                if (el) el.textContent = `"${letterQuote.value || 'El Psy Kongroo. â€” Hououin Kyouma'}"`; 
            });
        });

        // Expose for inline event handlers
        (window as any).loadDashboardData = loadDashboardData;
    </script>

    <style>
        .sidebar-glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
        }
        .dark .sidebar-glass {
            background: rgba(15, 23, 42, 0.8);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
        }
        .nav-item.active {
            background: linear-gradient(to right, rgba(236, 72, 153, 0.1), rgba(219, 39, 119, 0.05));
            color: #db2777;
            border-right: 3px solid #db2777;
        }
        .dark .nav-item.active {
            background: linear-gradient(to right, rgba(244, 114, 182, 0.1), rgba(219, 39, 119, 0.05));
            color: #f472b6;
            border-right: 3px solid #f472b6;
        }
    </style>

    <script is:inline>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }

        function updatePreview(input, imgId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById(imgId).src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function updateSasukePreview(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('sasukePreview').src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function toggleTheme() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }
    </script>

    <script is:inline src="https://unpkg.com/aos@2.3.1/dist/aos.js"></script>
    <script is:inline>
        AOS.init({ once: true, offset: 50, duration: 800 });
        if (window.lucide) { lucide.createIcons(); }
    </script>

</body>
</html>
